# üîê –†—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ –ø–æ —Å–∏—Å—Ç–µ–º–µ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏

## –û–±–∑–æ—Ä

–°–∏—Å—Ç–µ–º–∞ —Ç–æ—Ä–≥–æ–≤—ã—Ö —Å–∏–≥–Ω–∞–ª–æ–≤ —Ç–µ–ø–µ—Ä—å –≤–∫–ª—é—á–∞–µ—Ç –ø–æ–ª–Ω–æ—Ü–µ–Ω–Ω—É—é –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—é –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π —Å:
- –ë–µ–∑–æ–ø–∞—Å–Ω–æ–π —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–µ–π —Å —Ö–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ–º –ø–∞—Ä–æ–ª–µ–π
- –í—Ö–æ–¥–æ–º/–≤—ã—Ö–æ–¥–æ–º –∏–∑ —Å–∏—Å—Ç–µ–º—ã
- –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ–º —Å–µ—Å—Å–∏—è–º–∏
- –ò–∑–æ–ª—è—Ü–∏–µ–π –¥–∞–Ω–Ω—ã—Ö –º–µ–∂–¥—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏

## –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

### –ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã

1. **models/user.py** - –ú–æ–¥–µ–ª–∏ –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
   - `User` - –æ—Å–Ω–æ–≤–Ω–∞—è –º–æ–¥–µ–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
   - `UserCreate` - –¥–ª—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏
   - `UserLogin` - –¥–ª—è –≤—Ö–æ–¥–∞
   - `Session` - —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–µ—Å—Å–∏—è–º–∏

2. **services/auth_service.py** - –°–µ—Ä–≤–∏—Å –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏
   - –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
   - –í—Ö–æ–¥/–≤—ã—Ö–æ–¥
   - –•–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–∞—Ä–æ–ª–µ–π (SHA-256 —Å —Å–æ–ª—å—é)
   - –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–µ—Å—Å–∏—è–º–∏
   - –°–º–µ–Ω–∞ –ø–∞—Ä–æ–ª—è

3. **storage/dynamodb_storage.py** - –•—Ä–∞–Ω–∏–ª–∏—â–µ (–æ–±–Ω–æ–≤–ª–µ–Ω–æ)
   - –ú–µ—Ç–æ–¥—ã –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è/–ø–æ–ª—É—á–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
   - –ò–∑–æ–ª—è—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö –ø–æ username

4. **app_auth.py** - Gradio –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å —Å –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–µ–π

## –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

### –•–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–∞—Ä–æ–ª–µ–π

–ü–∞—Ä–æ–ª–∏ —Ö–µ—à–∏—Ä—É—é—Ç—Å—è —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º:
- **SHA-256** –¥–ª—è —Ö–µ—à–∏—Ä–æ–≤–∞–Ω–∏—è
- **–°–ª—É—á–∞–π–Ω–∞—è —Å–æ–ª—å** (32 —Å–∏–º–≤–æ–ª–∞) –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –ø–∞—Ä–æ–ª—è
- –°–æ–ª—å —Ö—Ä–∞–Ω–∏—Ç—Å—è –≤–º–µ—Å—Ç–µ —Å —Ö–µ—à–µ–º: `{salt}{hash}`

### –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è –∫ –ø–∞—Ä–æ–ª—è–º

- –ú–∏–Ω–∏–º—É–º 8 —Å–∏–º–≤–æ–ª–æ–≤
- –ú–∏–Ω–∏–º—É–º 1 –∑–∞–≥–ª–∞–≤–Ω–∞—è –±—É–∫–≤–∞
- –ú–∏–Ω–∏–º—É–º 1 —Å—Ç—Ä–æ—á–Ω–∞—è –±—É–∫–≤–∞
- –ú–∏–Ω–∏–º—É–º 1 —Ü–∏—Ñ—Ä–∞

### –°–µ—Å—Å–∏–∏

- –£–Ω–∏–∫–∞–ª—å–Ω—ã–π `session_id` (32-–±–∞–π—Ç–Ω—ã–π —Ç–æ–∫–µ–Ω)
- –°—Ä–æ–∫ –¥–µ–π—Å—Ç–≤–∏—è: 24 —á–∞—Å–∞
- –•—Ä–∞–Ω—è—Ç—Å—è –≤ –ø–∞–º—è—Ç–∏ (–≤ production –º–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å Redis/DynamoDB)

## –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ

### –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è

```python
from models.user import UserCreate
from services.auth_service import AuthService

auth_service = AuthService(storage)

user_create = UserCreate(
    username="anna",
    password="SecurePass123",
    email="anna@example.com",
    full_name="Anna Smith"
)

user = await auth_service.register_user(user_create)
```

### –í—Ö–æ–¥

```python
from models.user import UserLogin

user_login = UserLogin(
    username="anna",
    password="SecurePass123"
)

session = await auth_service.login(user_login)
# session.session_id –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è –ø–æ—Å–ª–µ–¥—É—é—â–∏—Ö –∑–∞–ø—Ä–æ—Å–æ–≤
```

### –í–∞–ª–∏–¥–∞—Ü–∏—è —Å–µ—Å—Å–∏–∏

```python
username = auth_service.validate_session(session_id)
if username:
    print(f"–ê–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω –∫–∞–∫: {username}")
else:
    print("–°–µ—Å—Å–∏—è –Ω–µ–¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–∞")
```

### –í—ã—Ö–æ–¥

```python
auth_service.logout(session_id)
```

## Web-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å (app_auth.py)

### –ó–∞–ø—É—Å–∫

```bash
python app_auth.py
```

–û—Ç–∫—Ä–æ–π—Ç–µ –±—Ä–∞—É–∑–µ—Ä: `http://localhost:7860`

### –§—É–Ω–∫—Ü–∏–∏

1. **Login / Register** - —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –∏ –≤—Ö–æ–¥
2. **Create Signal** - —Å–æ–∑–¥–∞–Ω–∏–µ —Ç–æ—Ä–≥–æ–≤—ã—Ö —Å–∏–≥–Ω–∞–ª–æ–≤ (—Ç—Ä–µ–±—É–µ—Ç –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏)
3. **My Signals** - –ø—Ä–æ—Å–º–æ—Ç—Ä —Å–≤–æ–∏—Ö —Å–∏–≥–Ω–∞–ª–æ–≤
4. **Delete Signal** - —É–¥–∞–ª–µ–Ω–∏–µ —Å–∏–≥–Ω–∞–ª–æ–≤
5. **Logout** - –≤—ã—Ö–æ–¥ –∏–∑ —Å–∏—Å—Ç–µ–º—ã

### Workflow

1. –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–π—Ç–µ—Å—å –Ω–∞ –≤–∫–ª–∞–¥–∫–µ "Login / Register"
2. –í–æ–π–¥–∏—Ç–µ —Å –≤–∞—à–∏–º–∏ credentials
3. –°–æ–∑–¥–∞–≤–∞–π—Ç–µ —Ç–æ—Ä–≥–æ–≤—ã–µ —Å–∏–≥–Ω–∞–ª—ã
4. –í—Å–µ —Å–∏–≥–Ω–∞–ª—ã –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–∏–≤—è–∑—ã–≤–∞—é—Ç—Å—è –∫ –≤–∞—à–µ–º—É username
5. –í—ã –≤–∏–¥–∏—Ç–µ —Ç–æ–ª—å–∫–æ —Å–≤–æ–∏ —Å–∏–≥–Ω–∞–ª—ã

## –ò–∑–æ–ª—è—Ü–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π

–ö–∞–∂–¥—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–∏–¥–∏—Ç **—Ç–æ–ª—å–∫–æ —Å–≤–æ–∏ —Å–∏–≥–Ω–∞–ª—ã**:

```python
# –í create_signal
signal = SignalTarget(
    name=name,
    symbol=symbol,
    user_id=username,  # –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∏–∑ —Å–µ—Å—Å–∏–∏
    # ...
)

# –ü—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ —Å–∏–≥–Ω–∞–ª–æ–≤
all_signals = await storage.get_all_signals()
user_signals = [s for s in all_signals if s.user_id == username]
```

## –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### –ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤

```bash
pytest tests/test_auth.py -v
```

### –ü–æ–∫—Ä—ã—Ç–∏–µ —Ç–µ—Å—Ç–æ–≤

- ‚úÖ –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
- ‚úÖ –î—É–±–ª–∏–∫–∞—Ç—ã username
- ‚úÖ –í–∞–ª–∏–¥–∞—Ü–∏—è –ø–∞—Ä–æ–ª–µ–π
- ‚úÖ –í—Ö–æ–¥ —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º–∏/–Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–º–∏ credentials
- ‚úÖ –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–µ—Å—Å–∏—è–º–∏
- ‚úÖ –ò—Å—Ç–µ—á–µ–Ω–∏–µ —Å–µ—Å—Å–∏–π
- ‚úÖ –°–º–µ–Ω–∞ –ø–∞—Ä–æ–ª—è
- ‚úÖ –•–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–∞—Ä–æ–ª–µ–π
- ‚úÖ –ò–∑–æ–ª—è—Ü–∏—è –º–µ–∂–¥—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏
- ‚úÖ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–æ—Ñ–∏–ª—è
- ‚úÖ –û—á–∏—Å—Ç–∫–∞ –∏—Å—Ç–µ–∫—à–∏—Ö —Å–µ—Å—Å–∏–π

## DynamoDB Structure

### –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏

```
PK: user#<username>
SK: profile
entity_type: user
username: <username>
password_hash: <hashed_password_with_salt>
email: <email>
created_at: <ISO timestamp>
is_active: true/false
```

### –°–∏–≥–Ω–∞–ª—ã

```
PK: signal#<signal_id>
SK: metadata
entity_type: signal
user_id: <username>  ‚Üê –°–≤—è–∑—å —Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º
symbol: BTCUSDT
target_price: 50000
# ... other fields
```

## –ú–∏–≥—Ä–∞—Ü–∏—è —Å –ø—Ä–æ—Å—Ç–æ–π —Å–∏—Å—Ç–µ–º—ã

–ï—Å–ª–∏ –≤—ã –∏—Å–ø–æ–ª—å–∑—É–µ—Ç–µ —Å—Ç–∞—Ä—É—é —Å–∏—Å—Ç–µ–º—É —Å `user_id` –ø–æ–ª–µ–º:

1. –î–∞–Ω–Ω—ã–µ **—Å–æ–≤–º–µ—Å—Ç–∏–º—ã** - —Å–∏–≥–Ω–∞–ª—ã —É–∂–µ –∏–º–µ—é—Ç `user_id`
2. –°–æ–∑–¥–∞–π—Ç–µ –∞–∫–∫–∞—É–Ω—Ç—ã –¥–ª—è —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö `user_id`:

```bash
# –°–æ–∑–¥–∞–π—Ç–µ –∞–∫–∫–∞—É–Ω—Ç—ã –¥–ª—è anna –∏ john
# —á–µ—Ä–µ–∑ Web UI –∏–ª–∏ API
```

3. –°—Ç–∞—Ä—ã–µ —Å–∏–≥–Ω–∞–ª—ã –±—É–¥—É—Ç –≤–∏–¥–Ω—ã –ø–æ—Å–ª–µ —Å–æ–∑–¥–∞–Ω–∏—è —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏—Ö –∞–∫–∫–∞—É–Ω—Ç–æ–≤

## Production —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏

### 1. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ Redis –¥–ª—è —Å–µ—Å—Å–∏–π

```python
# –ó–∞–º–µ–Ω–∏—Ç–µ in-memory storage –Ω–∞ Redis
self.sessions = redis.StrictRedis(
    host='localhost',
    port=6379,
    decode_responses=True
)
```

### 2. –î–æ–±–∞–≤—å—Ç–µ rate limiting

```python
# –û–≥—Ä–∞–Ω–∏—á—å—Ç–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–ø—ã—Ç–æ–∫ –≤—Ö–æ–¥–∞
from slowapi import Limiter

limiter = Limiter(key_func=get_remote_address)

@limiter.limit("5/minute")
async def login(...):
    ...
```

### 3. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ HTTPS

```python
app.launch(
    server_name="0.0.0.0",
    ssl_keyfile="key.pem",
    ssl_certfile="cert.pem"
)
```

### 4. –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ

–í—Å–µ –ø–æ–ø—ã—Ç–∫–∏ –≤—Ö–æ–¥–∞ –ª–æ–≥–∏—Ä—É—é—Ç—Å—è:
- –£—Å–ø–µ—à–Ω—ã–µ –≤—Ö–æ–¥—ã
- –ù–µ—É–¥–∞—á–Ω—ã–µ –ø–æ–ø—ã—Ç–∫–∏
- –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏
- –í—ã—Ö–æ–¥—ã

### 5. Email –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—è (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)

–î–æ–±–∞–≤—å—Ç–µ email verification:
```python
# –í –º–æ–¥–µ–ª—å User
email_verified: bool = False
verification_token: Optional[str] = None
```

## Troubleshooting

### "User not found"
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —á—Ç–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω
- Username —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª–µ–Ω –∫ —Ä–µ–≥–∏—Å—Ç—Ä—É (—Ö—Ä–∞–Ω–∏—Ç—Å—è –≤ lowercase)

### "Invalid password"
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø—Ä–∞–≤–∏–ª—å–Ω–æ—Å—Ç—å –ø–∞—Ä–æ–ª—è
- –£–±–µ–¥–∏—Ç–µ—Å—å —á—Ç–æ –ø–∞—Ä–æ–ª—å —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è–º

### "Session expired"
- –°–µ—Å—Å–∏–∏ –¥–µ–π—Å—Ç–≤—É—é—Ç 24 —á–∞—Å–∞
- –ü–æ—Å–ª–µ –∏—Å—Ç–µ—á–µ–Ω–∏—è –Ω—É–∂–Ω–æ –≤–æ–π—Ç–∏ –∑–∞–Ω–æ–≤–æ

### "Please login first"
- –£–±–µ–¥–∏—Ç–µ—Å—å —á—Ç–æ –≤—ã –≤–æ—à–ª–∏ –≤ —Å–∏—Å—Ç–µ–º—É
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —á—Ç–æ —Å–µ—Å—Å–∏—è –Ω–µ –∏—Å—Ç–µ–∫–ª–∞

## –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏

- [ ] –î–æ–±–∞–≤–∏—Ç—å OAuth (Google, GitHub)
- [ ] –î–≤—É—Ö—Ñ–∞–∫—Ç–æ—Ä–Ω–∞—è –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è (2FA)
- [ ] Email —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
- [ ] API —Ç–æ–∫–µ–Ω—ã –¥–ª—è –ø—Ä–æ–≥—Ä–∞–º–º–Ω–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞
- [ ] –†–æ–ª–∏ –∏ –ø—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞ (admin, user, viewer)

## –ü–æ–¥–¥–µ—Ä–∂–∫–∞

–ï—Å–ª–∏ —É –≤–∞—Å –≤–æ–∑–Ω–∏–∫–ª–∏ –≤–æ–ø—Ä–æ—Å—ã –∏–ª–∏ –ø—Ä–æ–±–ª–µ–º—ã, —Å–æ–∑–¥–∞–π—Ç–µ issue –≤ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏.
